<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><title>Flask+Vue.js(3)- Design User Model APIs | Weird Lab</title><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css"><script src="/js/third-party/jquery.min.js">           </script><script src="/js/third-party/velocity.min.js">           </script><script src="/js/third-party/velocity.ui.min.js">           </script><link rel="icon" href="/img/robomongo.png"><meta name="generator" content="Hexo 4.2.1"></head><body><nav id="nav-bar"><nav class="clear-fix" id="nav-container"><div class="pull-left" id="page-home"><a href="/">Weird Lab</a></div><i class="fa fa-bars pull-right" id="toggle-nav" aria-hidden="true"></i><ul class="pull-right" id="navs"><li><a class="nav" href="/">Home</a></li><li><a class="nav" href="/tags">Tags</a></li><li><a class="nav" href="/categories">Categories</a></li><li><a class="nav" href="/about">About</a></li></ul></nav></nav><header id="header-info"><div id="header-container"><div id="site-info"><div id="terminal-pl"><div id="top-bar"><ul id="control"><li class="btn"></li><li class="btn"></li><li class="btn"></li></ul><div id="file-path"><i class="fa fa-folder folder-ic" aria-hidden="true"></i> weird lab 10 X 10</div></div><div id="code-pl">weird lab:~/blog$
<span class="code-pl-input">source &quot;Flask+Vue.js(3)- Design User Model APIs.sh&quot;</span><br><br>weird lab:~/blog$
<span class="code-pl-input">printenv</span><br><span class="code-pl-output">CREATED_DATE = 2020-05-08</span><br><span class="code-pl-output">TAGS =</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/tags/#vue.js"><span class="code-pl-output">vue.js</span></a><span class="code-pl-output"> </span><span class="code-pl-output">:</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/tags/#flask"><span class="code-pl-output">flask</span></a><span class="code-pl-output"> </span><span class="code-pl-output">:</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/tags/#RESTful"><span class="code-pl-output">RESTful</span></a><span class="code-pl-output"> </span><span class="code-pl-output">:</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/tags/#API"><span class="code-pl-output">API</span></a><span class="code-pl-output"> </span><span class="code-pl-output">:</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/tags/#FullStack"><span class="code-pl-output">FullStack</span></a><span class="code-pl-output"> </span><span class="code-pl-output"></span><br><span class="code-pl-output">CATEGORIES =</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/categories/#Vue.js"><span class="code-pl-output">Vue.js</span></a><span class="code-pl-output"> </span><span class="code-pl-output">:</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/categories/#Flask"><span class="code-pl-output">Flask</span></a><span class="code-pl-output"> </span><span class="code-pl-output"></span><br><br>weird lab:~/blog$
<span class="code-pl-input">grep -lr $TAGS post</span><br><span class="code-pl-output">2020-05-01</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/2020/05/01/flask-vue-js-1/" target="_blank"><span class="code-pl-output">Flask+Vue.js(1)- The First Flask RESTful API</span></a><br><span class="code-pl-output">2020-05-01</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/2020/05/01/flask-vue-js-2/" target="_blank"><span class="code-pl-output">Flask+Vue.js(2)- Vue.js Connect With Flask RESTful API By Axios</span></a><br><span class="code-pl-output">2020-05-08</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/2020/05/08/flask-vue-js-3/" target="_blank"><span class="code-pl-output">Flask+Vue.js(3)- Design User Model APIs</span></a><br><span class="code-pl-output">2020-05-21</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/2020/05/21/flask-vue-js-4/" target="_blank"><span class="code-pl-output">Flask+Vue.js(4)- Vue.js connects with flask APIs</span></a><br><span class="code-pl-output">2020-05-21</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/2020/05/21/flask-vue-js-5/" target="_blank"><span class="code-pl-output">Flask+Vue.js(5)- User Homepage and User Avatar</span></a><br><span class="code-pl-output">2020-05-21</span><span class="code-pl-output"> </span><a class="code-pl-output-url" href="/2020/05/21/flask-vue-js-6/" target="_blank"><span class="code-pl-output">Flask+Vue.js(6)- Blog CRUD And Markdown</span></a><br><!--if page.next| > .prev
br
a(href=url_for(page.next.path))
  span.answer= page.next.title
br
br--><!--if page.prev| > .next
br
a(href=url_for(page.prev.path))
  span.answer= page.prev.title--></div></div></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><a class="article-title">Flask+Vue.js(3)- Design User Model APIs</a><time class="article-date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-08</time><p>Create <code>dev</code> branch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b dev</span><br></pre></td></tr></table></figure>

<h1 id="1-Database"><a href="#1-Database" class="headerlink" title="1.Database"></a>1.Database</h1><h2 id="1-1-ORM-SQLAIchemy"><a href="#1-1-ORM-SQLAIchemy" class="headerlink" title="1.1 ORM: SQLAIchemy"></a>1.1 ORM: SQLAIchemy</h2><p>Install <code>Flask-SQLAlchemy</code>and <code>Flask-Migrate</code> plugin.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(back-end) bash-3.2$ pip install flask-sqlalchemy flask-migrate</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>Modify the configuration file <code>back-end/config.py</code>, use SQLite by default.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line">load_dotenv(os.path.join(basedir, <span class="string">'.env'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span><span class="params">(object)</span>:</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = os.environ.get(<span class="string">'DATABASE_URL'</span>) <span class="keyword">or</span> \</span><br><span class="line">        <span class="string">'sqlite:///'</span> + os.path.join(basedir, <span class="string">'app.db'</span>)</span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>Modify <code>app/__init__.py</code>.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> Config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Flask-SQLAlchemy plugin</span></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"><span class="comment"># Flask-Migrate plugin</span></span><br><span class="line">migrate = Migrate()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">(config_class=Config)</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_object(config_class)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enable CORS</span></span><br><span class="line">    CORS(app)</span><br><span class="line">    <span class="comment"># Init Flask-SQLAlchemy</span></span><br><span class="line">    db.init_app(app)</span><br><span class="line">    <span class="comment"># Init Flask-Migrate</span></span><br><span class="line">    migrate.init_app(app, db)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># register blueprint</span></span><br><span class="line">    <span class="keyword">from</span> app.api <span class="keyword">import</span> bp <span class="keyword">as</span> api_bp</span><br><span class="line">    app.register_blueprint(api_bp, url_prefix=<span class="string">'/api'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
<h2 id="1-2-Define-User-Database-Model"><a href="#1-2-Define-User-Database-Model" class="headerlink" title="1.2 Define User Database Model"></a>1.2 Define User Database Model</h2><p>Create <code>app/models.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), index=<span class="literal">True</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    email = db.Column(db.String(<span class="number">120</span>), index=<span class="literal">True</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    password_hash = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;User &#123;&#125;&gt;'</span>.format(self.username)</span><br></pre></td></tr></table></figure>
<p>Modify <code>修改 app/__init__.py</code>, add at the final:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> models</span><br></pre></td></tr></table></figure>
<h1 id="1-3-Migrate-Database"><a href="#1-3-Migrate-Database" class="headerlink" title="1.3 Migrate Database"></a>1.3 Migrate Database</h1><pre><code>1. Init database
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(back-end) bash-3.2$ flask db init</span><br></pre></td></tr></table></figure>
2. Generate scripts
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(back-end) bash-3.2$ flask db migrate -m <span class="string">"add users table"</span></span><br></pre></td></tr></table></figure>
3. Move scripts to database
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(back-end) bash-3.2$ flask db upgrade</span><br></pre></td></tr></table></figure></code></pre><h2 id="1-4-Save-the-hash-value-of-user’s-password"><a href="#1-4-Save-the-hash-value-of-user’s-password" class="headerlink" title="1.4 Save the hash value of user’s password"></a>1.4 Save the hash value of user’s password</h2><p>Use <code>werkzeug.security</code> package’s function <code>generate_password_hash</code> and  <code>check_password_hash</code> to create hash code and verify if the hash of code is equal to the hash code.<br>Update User model</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug.security <span class="keyword">import</span> generate_password_hash, check_password_hash</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), index=<span class="literal">True</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    email = db.Column(db.String(<span class="number">120</span>), index=<span class="literal">True</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    password_hash = db.Column(db.String(<span class="number">128</span>))  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;User &#123;&#125;&gt;'</span>.format(self.username)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_password</span><span class="params">(self, password)</span>:</span></span><br><span class="line">        self.password_hash = generate_password_hash(password)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_password</span><span class="params">(self, password)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> check_password_hash(self.password_hash, password)</span><br></pre></td></tr></table></figure>
<h1 id="2-RESTful-API"><a href="#2-RESTful-API" class="headerlink" title="2. RESTful API"></a>2. RESTful API</h1><table>
<thead>
<tr>
<th>HTTP Method</th>
<th>URL</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>GET</code></td>
<td><code>/api/users</code></td>
<td>Return a set of all users</td>
</tr>
<tr>
<td><code>POST</code></td>
<td><code>/api/users</code></td>
<td>Register a new user</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/api/users/&lt;id&gt;</code></td>
<td>Return an user</td>
</tr>
<tr>
<td><code>PUT</code></td>
<td><code>/api/users/&lt;id&gt;</code></td>
<td>Modify an user</td>
</tr>
<tr>
<td><code>DELETE</code></td>
<td><code>/api/users/&lt;id&gt;</code></td>
<td>Delete an user</td>
</tr>
</tbody></table>
<p>Create <code>app/api/users.py</code>：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app.api <span class="keyword">import</span> bp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/users', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''Register a new user'''</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/users', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_users</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''Return a set of all users'''</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/users/&lt;int:id&gt;', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span><span class="params">(id)</span>:</span></span><br><span class="line">    <span class="string">'''Return an user'''</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/users/&lt;int:id&gt;', methods=['PUT'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_user</span><span class="params">(id)</span>:</span></span><br><span class="line">    <span class="string">'''Modify an user'''</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/users/&lt;int:id&gt;', methods=['DELETE'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_user</span><span class="params">(id)</span>:</span></span><br><span class="line">    <span class="string">'''Delete an user'''</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>Modify <code>app/api/__init__.py</code>, add in the final:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app.api <span class="keyword">import</span> ping, users</span><br></pre></td></tr></table></figure>
<h2 id="2-1-Transfome-the-User-Object-to-JSON"><a href="#2-1-Transfome-the-User-Object-to-JSON" class="headerlink" title="2.1 Transfome the User Object to JSON"></a>2.1 Transfome the User Object to JSON</h2><p>As we use User instance object at back-end, we need to return JSON Object when responding to front-end.<br>Modify <code>app/models.py</code>, add <code>to_dict</code> method to User model.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> url_for</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_dict</span><span class="params">(self, include_email=False)</span>:</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'id'</span>: self.id,</span><br><span class="line">            <span class="string">'username'</span>: self.username,</span><br><span class="line">            <span class="string">'_links'</span>: &#123;</span><br><span class="line">                <span class="string">'self'</span>: url_for(<span class="string">'api.get_user'</span>, id=self.id)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> include_email:</span><br><span class="line">            data[<span class="string">'email'</span>] = self.email</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<h2 id="2-2-Transform-the-set-of-all-users-to-JSON"><a href="#2-2-Transform-the-set-of-all-users-to-JSON" class="headerlink" title="2.2 Transform the set of all users to JSON"></a>2.2 Transform the set of all users to JSON</h2><p>There is <code>POST /users</code> in the API that needs to return the user collection, so the <code>to_collection_dict</code> method needs to be added. Considering that data models such as <code>Post</code> will be created later, so design a general class <code>PaginatedAPIMixin</code> in <code>app/models.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaginatedAPIMixin</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_collection_dict</span><span class="params">(query, page, per_page, endpoint, **kwargs)</span>:</span></span><br><span class="line">        resources = query.paginate(page, per_page, <span class="literal">False</span>)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'items'</span>: [item.to_dict() <span class="keyword">for</span> item <span class="keyword">in</span> resources.items],</span><br><span class="line">            <span class="string">'_meta'</span>: &#123;</span><br><span class="line">                <span class="string">'page'</span>: page,</span><br><span class="line">                <span class="string">'per_page'</span>: per_page,</span><br><span class="line">                <span class="string">'total_pages'</span>: resources.pages,</span><br><span class="line">                <span class="string">'total_items'</span>: resources.total</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'_links'</span>: &#123;</span><br><span class="line">                <span class="string">'self'</span>: url_for(endpoint, page=page, per_page=per_page,</span><br><span class="line">                                **kwargs),</span><br><span class="line">                <span class="string">'next'</span>: url_for(endpoint, page=page + <span class="number">1</span>, per_page=per_page,</span><br><span class="line">                                **kwargs) <span class="keyword">if</span> resources.has_next <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                <span class="string">'prev'</span>: url_for(endpoint, page=page - <span class="number">1</span>, per_page=per_page,</span><br><span class="line">                                **kwargs) <span class="keyword">if</span> resources.has_prev <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<p>Then, User inherits this class:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(PaginatedAPIMixin, db.Model)</span>:</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h2 id="2-3-Convert-JSON-into-user-object"><a href="#2-3-Convert-JSON-into-user-object" class="headerlink" title="2.3 Convert JSON into user object"></a>2.3 Convert JSON into user object</h2><p>The JSON object sent from the front-end needs to be converted into a User object</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">from_dict</span><span class="params">(self, data, new_user=False)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> field <span class="keyword">in</span> [<span class="string">'username'</span>, <span class="string">'email'</span>]:</span><br><span class="line">        <span class="keyword">if</span> field <span class="keyword">in</span> data:</span><br><span class="line">            setattr(self, field, data[field])</span><br><span class="line">    <span class="keyword">if</span> new_user <span class="keyword">and</span> <span class="string">'password'</span> <span class="keyword">in</span> data:</span><br><span class="line">        self.set_password(data[<span class="string">'password'</span>])</span><br></pre></td></tr></table></figure>
<h2 id="2-4-Error-handler"><a href="#2-4-Error-handler" class="headerlink" title="2.4 Error handler"></a>2.4 Error handler</h2><p>Create <code>app/api/errors.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> jsonify</span><br><span class="line"><span class="keyword">from</span> werkzeug.http <span class="keyword">import</span> HTTP_STATUS_CODES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error_response</span><span class="params">(status_code, message=None)</span>:</span></span><br><span class="line">    payload = &#123;<span class="string">'error'</span>: HTTP_STATUS_CODES.get(status_code, <span class="string">'Unknown error'</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span> message:</span><br><span class="line">        payload[<span class="string">'message'</span>] = message</span><br><span class="line">    response = jsonify(payload)</span><br><span class="line">    response.status_code = status_code</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bad_request</span><span class="params">(message)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> error_response(<span class="number">400</span>, message)</span><br></pre></td></tr></table></figure>
<h2 id="2-5-Register-a-new-user"><a href="#2-5-Register-a-new-user" class="headerlink" title="2.5 Register a new user"></a>2.5 Register a new user</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request, jsonify, url_for</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> app.api <span class="keyword">import</span> bp</span><br><span class="line"><span class="keyword">from</span> app.api.auth <span class="keyword">import</span> token_auth</span><br><span class="line"><span class="keyword">from</span> app.api.errors <span class="keyword">import</span> bad_request</span><br><span class="line"><span class="keyword">from</span> app.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/users', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''Register a new user'''</span></span><br><span class="line">    data = request.get_json()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">return</span> bad_request(<span class="string">'You must post JSON data.'</span>)</span><br><span class="line"></span><br><span class="line">    message = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="keyword">not</span> data.get(<span class="string">'username'</span>, <span class="literal">None</span>):</span><br><span class="line">        message[<span class="string">'username'</span>] = <span class="string">'Please provide a valid username.'</span></span><br><span class="line">    pattern = <span class="string">'^(([^&lt;&gt;()\[\]\\.,;:\s@"]+(\.[^&lt;&gt;()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]&#123;2,&#125;))$'</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'email'</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="keyword">not</span> re.match(pattern, data.get(<span class="string">'email'</span>, <span class="literal">None</span>)):</span><br><span class="line">        message[<span class="string">'email'</span>] = <span class="string">'Please provide a valid email address.'</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="keyword">not</span> data.get(<span class="string">'password'</span>, <span class="literal">None</span>):</span><br><span class="line">        message[<span class="string">'password'</span>] = <span class="string">'Please provide a valid password.'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> User.query.filter_by(username=data.get(<span class="string">'username'</span>, <span class="literal">None</span>)).first():</span><br><span class="line">        message[<span class="string">'username'</span>] = <span class="string">'Please use a different username.'</span></span><br><span class="line">    <span class="keyword">if</span> User.query.filter_by(email=data.get(<span class="string">'email'</span>, <span class="literal">None</span>)).first():</span><br><span class="line">        message[<span class="string">'email'</span>] = <span class="string">'Please use a different email address.'</span></span><br><span class="line">    <span class="keyword">if</span> message:</span><br><span class="line">        <span class="keyword">return</span> bad_request(message)</span><br><span class="line"></span><br><span class="line">    user = User()</span><br><span class="line">    user.from_dict(data, new_user=<span class="literal">True</span>)</span><br><span class="line">    db.session.add(user)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    response = jsonify(user.to_dict())</span><br><span class="line">    response.status_code = <span class="number">201</span></span><br><span class="line">    response.headers[<span class="string">'Location'</span>] = url_for(<span class="string">'api.get_user'</span>, id=user.id)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p>We can test API with <code>HTTPie</code> or <code>Postman</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(back-end) bash-3.2$ pip install --upgrade httpie</span><br></pre></td></tr></table></figure>
<p><img src="/2020/05/08/flask-vue-js-3/api1.jpeg" alt="api1"></p>
<h2 id="2-6-Get-a-single-user"><a href="#2-6-Get-a-single-user" class="headerlink" title="2.6 Get a single user"></a>2.6 Get a single user</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route('/users/&lt;int:id&gt;', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span><span class="params">(id)</span>:</span></span><br><span class="line">    <span class="string">'''返回一个用户'''</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(User.query.get_or_404(id).to_dict())</span><br></pre></td></tr></table></figure>
<p>We want to return JSON error information, modify <code>app/api/errors.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> app.api <span class="keyword">import</span> bp</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.app_errorhandler(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_found_error</span><span class="params">(error)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> error_response(<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.app_errorhandler(500)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">internal_error</span><span class="params">(error)</span>:</span></span><br><span class="line">    db.session.rollback()</span><br><span class="line">    <span class="keyword">return</span> error_response(<span class="number">500</span>)</span><br></pre></td></tr></table></figure>
<h1 id="2-7-Get-a-set-of-users"><a href="#2-7-Get-a-set-of-users" class="headerlink" title="2.7 Get a set of users"></a>2.7 Get a set of users</h1><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route('/users', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_users</span><span class="params">()</span>:</span></span><br><span class="line">    page = request.args.get(<span class="string">'page'</span>, <span class="number">1</span>, type=int)</span><br><span class="line">    per_page = min(request.args.get(<span class="string">'per_page'</span>, <span class="number">10</span>, type=int), <span class="number">100</span>)</span><br><span class="line">    data = User.to_collection_dict(User.query, page, per_page, <span class="string">'api.get_users'</span>)</span><br><span class="line">    <span class="keyword">return</span> jsonify(data)</span><br></pre></td></tr></table></figure>
<h1 id="2-8-Modify-an-user"><a href="#2-8-Modify-an-user" class="headerlink" title="2.8 Modify an user"></a>2.8 Modify an user</h1><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route('/users/&lt;int:id&gt;', methods=['PUT'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_user</span><span class="params">(id)</span>:</span></span><br><span class="line">    <span class="string">'''Modify an user'''</span></span><br><span class="line">    user = User.query.get_or_404(id)</span><br><span class="line">    data = request.get_json()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">return</span> bad_request(<span class="string">'You must post JSON data.'</span>)</span><br><span class="line"></span><br><span class="line">    message = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> data <span class="keyword">and</span> <span class="keyword">not</span> data.get(<span class="string">'username'</span>, <span class="literal">None</span>):</span><br><span class="line">        message[<span class="string">'username'</span>] = <span class="string">'Please provide a valid username.'</span></span><br><span class="line"></span><br><span class="line">    pattern = <span class="string">'^(([^&lt;&gt;()\[\]\\.,;:\s@"]+(\.[^&lt;&gt;()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]&#123;2,&#125;))$'</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'email'</span> <span class="keyword">in</span> data <span class="keyword">and</span> <span class="keyword">not</span> re.match(pattern, data.get(<span class="string">'email'</span>, <span class="literal">None</span>)):</span><br><span class="line">        message[<span class="string">'email'</span>] = <span class="string">'Please provide a valid email address.'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> data <span class="keyword">and</span> data[<span class="string">'username'</span>] != user.username <span class="keyword">and</span> \</span><br><span class="line">            User.query.filter_by(username=data[<span class="string">'username'</span>]).first():</span><br><span class="line">        message[<span class="string">'username'</span>] = <span class="string">'Please use a different username.'</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'email'</span> <span class="keyword">in</span> data <span class="keyword">and</span> data[<span class="string">'email'</span>] != user.email <span class="keyword">and</span> \</span><br><span class="line">            User.query.filter_by(email=data[<span class="string">'email'</span>]).first():</span><br><span class="line">        message[<span class="string">'email'</span>] = <span class="string">'Please use a different email address.'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> message:</span><br><span class="line">        <span class="keyword">return</span> bad_request(message)</span><br><span class="line"></span><br><span class="line">    user.from_dict(data, new_user=<span class="literal">False</span>)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> jsonify(user.to_dict())</span><br></pre></td></tr></table></figure>
<h1 id="3-API-Authentication"><a href="#3-API-Authentication" class="headerlink" title="3 API Authentication"></a>3 API Authentication</h1><p>In order to simplify the interaction between the client and the server when using token authentication, we can use the Flask-HTTPAuth plugin</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(back-end) bash-3.2$ pip install flask-httpauth</span><br></pre></td></tr></table></figure>
<h2 id="3-1-Add-token-model-to-User-model"><a href="#3-1-Add-token-model-to-User-model" class="headerlink" title="3.1 Add token model to User model"></a>3.1 Add token model to User model</h2><p>modify <code>app/models.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(PaginatedAPIMixin, db.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    token = db.Column(db.String(<span class="number">32</span>), index=<span class="literal">True</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    token_expiration = db.Column(db.DateTime)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_token</span><span class="params">(self, expires_in=<span class="number">3600</span>)</span>:</span></span><br><span class="line">        now = datetime.utcnow()</span><br><span class="line">        <span class="keyword">if</span> self.token <span class="keyword">and</span> self.token_expiration &gt; now + timedelta(seconds=<span class="number">60</span>):</span><br><span class="line">            <span class="keyword">return</span> self.token</span><br><span class="line">        self.token = base64.b64encode(os.urandom(<span class="number">24</span>)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        self.token_expiration = now + timedelta(seconds=expires_in)</span><br><span class="line">        db.session.add(self)</span><br><span class="line">        <span class="keyword">return</span> self.token</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">revoke_token</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.token_expiration = datetime.utcnow() - timedelta(seconds=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_token</span><span class="params">(token)</span>:</span></span><br><span class="line">        user = User.query.filter_by(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> user.token_expiration &lt; datetime.utcnow():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure>
<p>Create database migration script and apply it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(back-end) bash-3.2$ flask db migrate -m <span class="string">"user add tokens"</span></span><br></pre></td></tr></table></figure>
<h2 id="3-2-HTTP-Basic-Authentication"><a href="#3-2-HTTP-Basic-Authentication" class="headerlink" title="3.2 HTTP Basic Authentication"></a>3.2 HTTP Basic Authentication</h2><p>Create <code>app/api/auth.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> g</span><br><span class="line"><span class="keyword">from</span> flask_httpauth <span class="keyword">import</span> HTTPBasicAuth</span><br><span class="line"><span class="keyword">from</span> app.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> app.api.errors <span class="keyword">import</span> error_response</span><br><span class="line"></span><br><span class="line">basic_auth = HTTPBasicAuth()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@basic_auth.verify_password</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_password</span><span class="params">(username, password)</span>:</span></span><br><span class="line">    <span class="string">'''check username and password'''</span></span><br><span class="line">    user = User.query.filter_by(username=username).first()</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    g.current_user = user</span><br><span class="line">    <span class="keyword">return</span> user.check_password(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@basic_auth.error_handler</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">basic_auth_error</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''return false when authentication failed'''</span></span><br><span class="line">    <span class="keyword">return</span> error_response(<span class="number">401</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-3-Apply-token-at-client-side"><a href="#3-3-Apply-token-at-client-side" class="headerlink" title="3.3 Apply token at client-side"></a>3.3 Apply token at client-side</h2><p>Now we have realize the support of Basic Auth authentication, so we can add a token retrieval route so that the client can call it when the token is needed</p>
<p>Create <code>app/api/tokens.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> jsonify, g</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> app.api <span class="keyword">import</span> bp</span><br><span class="line"><span class="keyword">from</span> app.api.auth <span class="keyword">import</span> basic_auth</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/tokens', methods=['POST'])</span></span><br><span class="line"><span class="meta">@basic_auth.login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_token</span><span class="params">()</span>:</span></span><br><span class="line">    token = g.current_user.get_token()</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">'token'</span>: token&#125;)</span><br></pre></td></tr></table></figure>

<p>Modify <code>app/api/__init__.py</code> add</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app.api <span class="keyword">import</span> ping, users, tokens</span><br></pre></td></tr></table></figure>
<p>at the end.</p>
<h2 id="3-4-HTTP-Token-Authentication"><a href="#3-4-HTTP-Token-Authentication" class="headerlink" title="3.4 HTTP Token Authentication"></a>3.4 HTTP Token Authentication</h2><p>After the user gets the token through Basic Auth, the subsequent requests can access other APIs as long as the token is attached. Modify <code>app/api/auth.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_httpauth <span class="keyword">import</span> HTTPBasicAuth, HTTPTokenAuth</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">token_auth = HTTPTokenAuth()</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@token_auth.verify_token</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_token</span><span class="params">(token)</span>:</span></span><br><span class="line">    <span class="string">'''verify if tokens is required and tokens exist and valid'''</span></span><br><span class="line">    g.current_user = User.check_token(token) <span class="keyword">if</span> token <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> g.current_user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@token_auth.error_handler</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">token_auth_error</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''return false when Token Auth failed'''</span></span><br><span class="line">    <span class="keyword">return</span> error_response(<span class="number">401</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-5-Protect-API-routings-with-Token-Auth"><a href="#3-5-Protect-API-routings-with-Token-Auth" class="headerlink" title="3.5 Protect API routings with Token Auth"></a>3.5 Protect API routings with Token Auth</h2><p>All APIs view functions need to add <code>@token_auth.login_required</code> except <code>create_user()</code>.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.route('/users', methods=['GET'])</span></span><br><span class="line"><span class="meta">@token_auth.login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_users</span><span class="params">()</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/users/&lt;int:id&gt;', methods=['GET'])</span></span><br><span class="line"><span class="meta">@token_auth.login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span><span class="params">(id)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="3-6-Remove-Token"><a href="#3-6-Remove-Token" class="headerlink" title="3.6 Remove Token"></a>3.6 Remove Token</h2><p>Modiy <code>app/api/tokens.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app.api.auth <span class="keyword">import</span> basic_auth, token_auth</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/tokens', methods=['DELETE'])</span></span><br><span class="line"><span class="meta">@token_auth.login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">revoke_token</span><span class="params">()</span>:</span></span><br><span class="line">    g.current_user.revoke_token()</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>, <span class="number">204</span></span><br></pre></td></tr></table></figure>

<h1 id="4-Commit-Code"><a href="#4-Commit-Code" class="headerlink" title="4 Commit Code"></a>4 Commit Code</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">"3. Design User model API"</span></span><br><span class="line">$ git checkout master</span><br><span class="line">$ git merge dev</span><br><span class="line">$ git branch -d dev</span><br></pre></td></tr></table></figure>

<p>Push the local <code>master</code> branch to the <code>master</code> branch in Github repository:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push -u origin master</span><br></pre></td></tr></table></figure>
<p>Make a <code>tag</code> then upload:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git tag v0.3</span><br><span class="line">$ git push origin v0.3</span><br></pre></td></tr></table></figure>
<p>The code has been uploaded to <a href="https://github.com/guguji123/blog/releases/tag/v0.3" target="_blank" rel="noopener">https://github.com/guguji123/blog/releases/tag/v0.3</a></p>
</article><article id="post"><script type="text/javascript" src="https://utteranc.es/client.js" repo="guguji123/blog_comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></article><nav id="pagination"><div class="pagination clear-fix"><div class="page-prev pull-left"><a href="/2020/05/21/flask-vue-js-4/"><i class="fa fa-chevron-left"> </i><span>Flask+Vue.js(4)- Vue.js connects with flask APIs</span></a></div><div class="page-next pull-right"><a href="/2020/05/01/flask-vue-js-2/"><span>Flask+Vue.js(2)- Vue.js Connect With Flask RESTful API By Axios</span><i class="fa fa-chevron-right"></i></a></div></div></nav></div></div><footer><div id="footer-inner"><div class="social-icons"></div><p class="design-info">Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme <a href="https://github.com/lazysheep666/terminal_theme" target="_blank">Teminal</a> (<a href="https://github.com/Tonny-Gu/terminal_theme" target="_blank">NekoDaemon Remix</a>)</p><p class="design-info"> 
 Copyright © 2020 weird lab</p></div></footer><script src="/js/nav.js"></script><script src="/js/scroll.js"></script><script src="/js/index.js"></script></body></html>